// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // ou "mysql", "sqlite" conforme necessário
  url      = env("DATABASE_URL")
}

/// ============================================
/// MODELO: Usuario
/// ============================================
model Usuario {
  id                String    @id @default(uuid())
  email             String    @unique
  nome              String
  senha_hash        String    @map("senha_hash")
  perfil            String    @default("usuario") // admin, gestor, engenheiro, usuario
  is_ativo          Boolean   @default(true) @map("is_ativo")
  
  // Relações
  gates_criados     Gate[]    @relation("GateCriadoPor")
  gates_aprovados   Gate[]    @relation("GateAprovadoPor")
  medicoes          Medicao[]
  medicoes_aprovadas Medicao[] @relation("MedicaoAprovadaPor")
  obras_permitidas  UsuarioObra[] // Obras que o usuário tem permissão de acessar
  eaps_criadas      Eap[]      @relation("EapCriadaPor") // EAPs criadas pelo usuário
  baselines_propostas BaselineComercial[] @relation("BaselinePropostaPor")
  baselines_homologadas BaselineComercial[] @relation("BaselineHomologadaPor")
  baselines_rejeitadas BaselineComercial[] @relation("BaselineRejeitadaPor")
  competencia_gates_aprovados CompetenciaGate[] @relation("CompetenciaGateAprovadoPor")
  competencia_gates_rejeitados CompetenciaGate[] @relation("CompetenciaGateRejeitadoPor")
  
  // Relações de Comunicados
  comunicados_criados Comunicado[] @relation("ComunicadoAutor")
  comunicados_validados Comunicado[] @relation("ComunicadoValidadorSetor")
  comunicados_publicados Comunicado[] @relation("ComunicadoPublicador")
  comunicados_aprovados_corp Comunicado[] @relation("ComunicadoAprovadorCorporativo")
  confirmacoes_leitura ConfirmacaoLeitura[]
  
  // Timestamps
  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")
  deleted_at DateTime? @map("deleted_at")

  @@index([email])
  @@index([perfil])
  @@index([is_ativo])
  @@map("usuarios")
}

/// ============================================
/// MODELO: Obras
/// ============================================
model Obra {
  id                String    @id @default(uuid())
  codigo            String    @unique
  nome              String
  descricao         String?
  cliente           String?
  data_inicio       DateTime?
  data_fim_prevista DateTime? @map("data_fim_prevista")
  data_fim_real     DateTime? @map("data_fim_real")
  status            String    @default("planejamento") // planejamento, em_andamento, pausada, concluida, cancelada
  orcamento_total   Decimal?  @map("orcamento_total") @db.Decimal(15, 2)
  
  // Relações
  baseline_comercial BaselineComercial[]
  gates              Gate[]
  medicoes           Medicao[]
  usuarios_permitidos UsuarioObra[] // Usuários que têm permissão nesta obra
  competencias_mensais CompetenciaMensal[] // FASE 1: Competências mensais da obra
  competencia_gates CompetenciaGate[] // Backend Mínimo: Gates de competências
  
  // Timestamps
  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")
  deleted_at DateTime? @map("deleted_at")

  @@map("obras")
}

/// ============================================
/// MODELO: UsuarioObra (Permissões)
/// ============================================
/// Tabela de relacionamento N:N entre Usuario e Obra
/// Define quais usuários têm permissão de acessar quais obras
model UsuarioObra {
  id         String   @id @default(uuid())
  usuario_id String   @map("usuario_id")
  obra_id    String   @map("obra_id")
  permissao  String   @default("leitura") // leitura, escrita, administrador
  is_ativo   Boolean  @default(true) @map("is_ativo")
  
  // Relações
  usuario Usuario @relation(fields: [usuario_id], references: [id], onDelete: Cascade)
  obra    Obra    @relation(fields: [obra_id], references: [id], onDelete: Cascade)
  
  // Timestamps
  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")
  deleted_at DateTime? @map("deleted_at")

  @@unique([usuario_id, obra_id])
  @@index([usuario_id])
  @@index([obra_id])
  @@index([is_ativo])
  @@map("usuario_obra")
}

/// ============================================
/// MODELO: Baseline Comercial
/// ============================================
model BaselineComercial {
  id              String    @id @default(uuid())
  obra_id         String    @map("obra_id")
  versao          Int
  descricao       String?
  valor_total     Decimal   @map("valor_total") @db.Decimal(15, 2)
  is_ativo        Boolean   @default(false) @map("is_ativo")
  
  // Status e Homologação (v2.1)
  status          String    @default("proposta") @map("status") // "proposta" | "homologada" | "rejeitada"
  proposta_por    String?   @map("proposta_por") // usuario_id que propôs
  proposta_em     DateTime? @map("proposta_em")
  homologada_por  String?   @map("homologada_por") // usuario_id que homologou
  homologada_em   DateTime? @map("homologada_em")
  rejeitada_por   String?   @map("rejeitada_por")
  rejeitada_em    DateTime? @map("rejeitada_em")
  motivo_rejeicao String?   @map("motivo_rejeicao")
  
  // Campos legados (mantidos para compatibilidade)
  data_aprovacao  DateTime? @map("data_aprovacao") // Deprecated: usar homologada_em
  aprovado_por    String?   @map("aprovado_por") // Deprecated: usar homologada_por
  
  // Relações
  obra Obra @relation(fields: [obra_id], references: [id], onDelete: Cascade)
  eap  Eap[]
  usuario_proponente Usuario? @relation("BaselinePropostaPor", fields: [proposta_por], references: [id], onDelete: SetNull)
  usuario_homologador Usuario? @relation("BaselineHomologadaPor", fields: [homologada_por], references: [id], onDelete: SetNull)
  usuario_rejeitador Usuario? @relation("BaselineRejeitadaPor", fields: [rejeitada_por], references: [id], onDelete: SetNull)
  
  // Timestamps
  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")
  deleted_at DateTime? @map("deleted_at")

  @@unique([obra_id, versao])
  @@index([status])
  @@index([proposta_por])
  @@index([homologada_por])
  @@map("baseline_comercial")
}

/// ============================================
/// MODELO: EAP (Estrutura Analítica do Projeto)
/// ============================================
model Eap {
  id                  String   @id @default(uuid())
  baseline_comercial_id String @map("baseline_comercial_id")
  codigo              String
  descricao           String
  tipo                String   // "comercial" ou "operacional"
  nivel               Int
  eap_pai_id          String?  @map("eap_pai_id")
  unidade_medida      String?  @map("unidade_medida")
  quantidade          Decimal? @db.Decimal(15, 4)
  valor_unitario      Decimal? @map("valor_unitario") @db.Decimal(15, 2)
  valor_total         Decimal? @map("valor_total") @db.Decimal(15, 2)
  ordem               Int
  is_folha            Boolean  @default(false) @map("is_folha")
  usuario_id          String?  @map("usuario_id") // Usuário que criou a EAP (auditoria)
  
  // Relações
  baseline_comercial BaselineComercial @relation(fields: [baseline_comercial_id], references: [id], onDelete: Cascade)
  usuario_criador Usuario? @relation("EapCriadaPor", fields: [usuario_id], references: [id], onDelete: SetNull)
  
  // Self-reference para hierarquia (item pai)
  pai   Eap?  @relation("EapHierarchy", fields: [eap_pai_id], references: [id], onDelete: SetNull)
  filhos Eap[] @relation("EapHierarchy")
  
  // Relações de fator de conversão
  // Quando é EAP Comercial, pode ter múltiplos fatores de conversão para EAPs Operacionais
  fatores_como_comercial EapFatorConversao[] @relation("EapComercial")
  
  // Quando é EAP Operacional, pode estar relacionada a uma EAP Comercial
  fatores_como_operacional EapFatorConversao[] @relation("EapOperacional")
  
  // Relações com medições
  medicoes Medicao[]
  
  // Timestamps
  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")
  deleted_at DateTime? @map("deleted_at")

  @@unique([baseline_comercial_id, codigo])
  @@index([baseline_comercial_id])
  @@index([eap_pai_id])
  @@index([tipo])
  @@index([usuario_id])
  @@map("eap")
}

/// ============================================
/// MODELO: EAP Fator de Conversão
/// ============================================
/// REGRA: Cada item da EAP Comercial pode ter um ou mais itens da EAP Operacional
/// através de fatores de conversão que definem a relação quantidade/valor
model EapFatorConversao {
  id                 String  @id @default(uuid())
  eap_comercial_id   String  @map("eap_comercial_id")
  eap_operacional_id String  @map("eap_operacional_id")
  fator_quantidade   Decimal @map("fator_quantidade") @db.Decimal(15, 6)
  fator_valor        Decimal? @map("fator_valor") @db.Decimal(15, 6)
  observacoes        String?
  is_ativo           Boolean @default(true) @map("is_ativo")
  
  // Relações
  eap_comercial   Eap @relation("EapComercial", fields: [eap_comercial_id], references: [id], onDelete: Cascade)
  eap_operacional Eap @relation("EapOperacional", fields: [eap_operacional_id], references: [id], onDelete: Cascade)
  
  // Timestamps
  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")
  deleted_at DateTime? @map("deleted_at")

  @@unique([eap_comercial_id, eap_operacional_id])
  @@index([eap_comercial_id])
  @@index([eap_operacional_id])
  @@index([is_ativo])
  @@map("eap_fator_conversao")
}

/// ============================================
/// ENUM: Códigos dos Gates Oficiais
/// ============================================
enum GateCodigo {
  G1  // Liberação da Obra (Corporativo)
  G2  // Fechamento de Produção
  G3  // Fechamento de Custos
  G4  // Fechamento Comercial
  G5  // Qualidade OK (TRAVA)
  G6  // SST OK (TRAVA)
  G7  // Financeiro OK
  G8  // Gerencial OK
  G9  // Competência Concluída
}

/// ============================================
/// MODELO: Gates (Portões/Marcos do Projeto)
/// ============================================
/// FASE 1: Gates fixos (G1-G9) conforme conceito oficial
model Gate {
  id                  String      @id @default(uuid())
  obra_id             String      @map("obra_id")
  codigo              GateCodigo  // Enum fixo: G1 a G9
  nome                String
  descricao           String?
  ordem               Int         // Ordem imutável: 1 a 9
  data_prevista       DateTime?   @map("data_prevista")
  data_real           DateTime?   @map("data_real")
  status              String      @default("pendente") // pendente, em_analise, aprovado, rejeitado
  usuario_id          String?     @map("usuario_id") // Usuário que criou/executou a ação
  aprovado_por        String?     @map("aprovado_por") // Mantido para compatibilidade
  usuario_aprovador_id String?     @map("usuario_aprovador_id") // Usuário que aprovou
  data_aprovacao      DateTime?   @map("data_aprovacao")
  observacoes         String?
  criterios_aprovacao String?     @map("criterios_aprovacao") // JSON ou texto
  
  // Relações
  obra Obra @relation(fields: [obra_id], references: [id], onDelete: Cascade)
  usuario_criador Usuario? @relation("GateCriadoPor", fields: [usuario_id], references: [id], onDelete: SetNull)
  usuario_aprovador Usuario? @relation("GateAprovadoPor", fields: [usuario_aprovador_id], references: [id], onDelete: SetNull)
  
  // Timestamps
  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")
  deleted_at DateTime? @map("deleted_at")

  @@unique([obra_id, codigo])
  @@index([obra_id])
  @@index([usuario_id])
  @@index([usuario_aprovador_id])
  @@index([status])
  @@index([ordem])
  @@index([codigo])
  @@map("gates")
}

/// ============================================
/// ENUM: Tipo de Medição
/// ============================================
enum TipoMedicao {
  MP  // Medição de Produção (o que foi realmente executado)
  MC  // Medição do Cliente (o que será faturado)
}

/// ============================================
/// MODELO: Medição
/// ============================================
/// FASE 1: Separação MP/MC conforme conceito oficial
/// Representa medições realizadas em uma obra
model Medicao {
  id                  String      @id @default(uuid())
  obra_id             String      @map("obra_id")
  eap_id              String?     @map("eap_id") // EAP relacionada (opcional)
  usuario_id          String      @map("usuario_id") // Usuário que realizou a medição
  tipo                TipoMedicao // FASE 1: MP ou MC (obrigatório)
  periodo_referencia  String      @map("periodo_referencia") // Ex: "2026-01", "2026-Q1"
  data_medicao        DateTime    @map("data_medicao")
  quantidade_medida    Decimal     @map("quantidade_medida") @db.Decimal(15, 4)
  valor_medido         Decimal?    @map("valor_medido") @db.Decimal(15, 2)
  observacoes          String?
  status              String      @default("rascunho") // rascunho, enviada, aprovada, rejeitada
  aprovado_por_id     String?     @map("aprovado_por_id")
  data_aprovacao       DateTime?   @map("data_aprovacao")
  
  // Relações
  obra Obra @relation(fields: [obra_id], references: [id], onDelete: Cascade)
  eap  Eap? @relation(fields: [eap_id], references: [id], onDelete: SetNull)
  usuario Usuario @relation(fields: [usuario_id], references: [id], onDelete: Restrict)
  aprovado_por Usuario? @relation("MedicaoAprovadaPor", fields: [aprovado_por_id], references: [id], onDelete: SetNull)
  
  // Timestamps
  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")
  deleted_at DateTime? @map("deleted_at")

  @@index([obra_id])
  @@index([eap_id])
  @@index([usuario_id])
  @@index([periodo_referencia])
  @@index([data_medicao])
  @@index([status])
  @@index([tipo]) // FASE 1: Índice para filtros MP/MC
  @@map("medicoes")
}

/// ============================================
/// MODELO: Insumo
/// ============================================
/// Representa insumos e materiais de construção
model Insumo {
  id                String    @id @default(uuid())
  codigo            String    @unique
  nome              String
  unidade           String    // m³, kg, un, saco, milheiro
  categoria         String
  preco_estimado    Decimal   @map("preco_estimado") @db.Decimal(15, 2)
  estoque           Decimal   @default(0) @db.Decimal(15, 4)
  
  // Timestamps
  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")
  deleted_at DateTime? @map("deleted_at")

  @@index([codigo])
  @@index([categoria])
  @@map("insumos")
}

/// ============================================
/// ENUM: Status da Competência
/// ============================================
enum CompetenciaStatus {
  aberta
  fechada
}

/// ============================================
/// ENUM: Status do Gate
/// ============================================
enum GateStatus {
  pendente
  em_analise
  aprovado
  rejeitado
  bloqueado
}

/// ============================================
/// MODELO: Competência Mensal
/// ============================================
/// Backend Mínimo: Competência + 9 Gates (Fechamento Mensal)
/// Representa um período mensal de fechamento de uma obra
model CompetenciaMensal {
  id            String            @id @default(uuid())
  obra_id       String            @map("obra_id")
  periodo       String            // Formato: "2026-01" (YYYY-MM)
  status        CompetenciaStatus @default(aberta) @map("status")
  aberta_em     DateTime          @default(now()) @map("aberta_em")
  fechada_em    DateTime?         @map("fechada_em")
  observacoes   String?
  
  // Relações
  obra Obra @relation(fields: [obra_id], references: [id], onDelete: Cascade)
  gates CompetenciaGate[] // Gates vinculados a esta competência
  
  // Timestamps
  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")
  deleted_at DateTime? @map("deleted_at")
  
  @@unique([obra_id, periodo])
  @@index([obra_id, status])
  @@index([obra_id])
  @@index([status])
  @@map("competencia_mensal")
}

/// ============================================
/// MODELO: Gate da Competência
/// ============================================
/// Backend Mínimo: 9 Gates de Fechamento Mensal
/// Representa um gate específico de uma competência mensal
model CompetenciaGate {
  id                String      @id @default(uuid())
  competencia_id    String      @map("competencia_id")
  obra_id           String      @map("obra_id") // Redundante mas útil para queries
  numero            Int         // 1..9
  nome              String
  status            GateStatus  @default(pendente) @map("status")
  trava             Boolean     @default(false) @map("trava") // true somente gates 5 e 6
  ordem             Int         // Igual ao numero
  aprovado_por_id   String?     @map("aprovado_por_id")
  aprovado_em       DateTime?   @map("aprovado_em")
  rejeitado_por_id  String?     @map("rejeitado_por_id")
  rejeitado_em      DateTime?   @map("rejeitado_em")
  motivo_rejeicao   String?     @map("motivo_rejeicao")
  observacoes       String?
  
  // Relações
  competencia CompetenciaMensal @relation(fields: [competencia_id], references: [id], onDelete: Cascade)
  obra Obra @relation(fields: [obra_id], references: [id], onDelete: Cascade)
  aprovado_por Usuario? @relation("CompetenciaGateAprovadoPor", fields: [aprovado_por_id], references: [id], onDelete: SetNull)
  rejeitado_por Usuario? @relation("CompetenciaGateRejeitadoPor", fields: [rejeitado_por_id], references: [id], onDelete: SetNull)
  
  // Timestamps
  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")
  deleted_at DateTime? @map("deleted_at")
  
  @@unique([competencia_id, numero])
  @@index([competencia_id])
  @@index([obra_id, numero, status])
  @@map("competencia_gate")
}


/// ============================================
/// ENUM: Escopo do Comunicado
/// ============================================
enum ComunicadoEscopo {
  global       // Todas as obras (requer aprovação corporativa)
  obra         // Apenas uma obra específica
  setor        // Apenas um setor específico
}

/// ============================================
/// ENUM: Prioridade do Comunicado
/// ============================================
enum ComunicadoPrioridade {
  normal
  urgente
  critico
}

/// ============================================
/// ENUM: Status do Comunicado
/// ============================================
enum ComunicadoStatus {
  rascunho
  aguardando_validacao_setor
  devolvido_para_ajustes
  validado_pelo_setor
  aguardando_publicacao
  aguardando_aprovacao_corporativa
  publicado
  expirado
  cancelado
}

/// ============================================
/// MODELO: Comunicado
/// ============================================
/// Comunicados da Intranet com fluxo de aprovação
model Comunicado {
  id                    String              @id @default(uuid())
  titulo                String
  conteudo              String              @db.Text
  escopo                ComunicadoEscopo    @default(obra)
  prioridade            ComunicadoPrioridade @default(normal)
  status                ComunicadoStatus    @default(rascunho)
  categoria             String?             // SSMA, Qualidade, Institucional, Obra, etc.
  setor_origem          String?             @map("setor_origem")
  obra_id               String?             @map("obra_id") // Null se escopo = global
  fixado                Boolean             @default(false) // Comunicado fixado no topo
  exige_confirmacao     Boolean             @default(false) @map("exige_confirmacao") // Exige "Li e estou ciente"
  
  // Fluxo de Aprovação
  autor_id              String              @map("autor_id")
  validador_setor_id    String?             @map("validador_setor_id")
  validado_setor_em     DateTime?           @map("validado_setor_em")
  publicador_id         String?             @map("publicador_id")
  publicado_em          DateTime?           @map("publicado_em")
  aprovador_corporativo_id String?          @map("aprovador_corporativo_id")
  aprovado_corporativo_em DateTime?         @map("aprovado_corporativo_em")
  
  // Datas de Vigência
  data_publicacao       DateTime?           @map("data_publicacao") // Pode ser agendada
  data_expiracao        DateTime?           @map("data_expiracao")
  
  // Errata
  comunicado_original_id String?            @map("comunicado_original_id")
  is_errata             Boolean             @default(false) @map("is_errata")
  
  // Relações
  autor                 Usuario             @relation("ComunicadoAutor", fields: [autor_id], references: [id], onDelete: Cascade)
  validador_setor       Usuario?            @relation("ComunicadoValidadorSetor", fields: [validador_setor_id], references: [id], onDelete: SetNull)
  publicador            Usuario?            @relation("ComunicadoPublicador", fields: [publicador_id], references: [id], onDelete: SetNull)
  aprovador_corporativo Usuario?            @relation("ComunicadoAprovadorCorporativo", fields: [aprovador_corporativo_id], references: [id], onDelete: SetNull)
  comunicado_original   Comunicado?         @relation("ComunicadoErrata", fields: [comunicado_original_id], references: [id], onDelete: SetNull)
  erratas               Comunicado[]        @relation("ComunicadoErrata")
  confirmacoes_leitura  ConfirmacaoLeitura[]
  
  // Timestamps
  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")
  deleted_at DateTime? @map("deleted_at")
  
  @@index([escopo, status])
  @@index([obra_id, status])
  @@index([autor_id])
  @@index([status])
  @@index([publicado_em])
  @@index([fixado])
  @@map("comunicados")
}

/// ============================================
/// MODELO: Confirmação de Leitura
/// ============================================
/// Registro de quem leu comunicados que exigem confirmação
model ConfirmacaoLeitura {
  id              String    @id @default(uuid())
  comunicado_id   String    @map("comunicado_id")
  usuario_id      String    @map("usuario_id")
  confirmado_em   DateTime  @default(now()) @map("confirmado_em")
  
  // Relações
  comunicado      Comunicado @relation(fields: [comunicado_id], references: [id], onDelete: Cascade)
  usuario         Usuario    @relation(fields: [usuario_id], references: [id], onDelete: Cascade)
  
  // Timestamps
  created_at DateTime @default(now()) @map("created_at")
  
  @@unique([comunicado_id, usuario_id])
  @@index([comunicado_id])
  @@index([usuario_id])
  @@map("confirmacoes_leitura")
}

